<div class="columns">
  <div class="column col-12">
    <ul class="breadcrumb">
      <li class="breadcrumb-item">
        <%= link_to "All Members", admin_members_path %>
      </li>
        <li class="breadcrumb-item">
        <%= link_to @member.preferred_name, admin_member_path(@member) %>
      </li>
    </ul>
  </div>
</div>

<div class="columns">
  <div class="column col-4 col-sm-12">

    <div class="panel member-panel">
      <div class="panel-header">
        <h1 class="h3">
          <%= @member.preferred_name %>
        </h1>
      </div>
      <div class="panel-body">
        <ul class="member-stats">
          <li><%= feather_icon "message-square" %><%= member_pronoun(@member) %></li>
          <li><%= feather_icon "user" %><%= @member.full_name %></li>
          <li><%= feather_icon "mail" %><%= @member.email %></li>
          <li><%= feather_icon "smartphone" %><%= format_phone_number @member.phone_number %></li>
          <li>
            <%= feather_icon "credit-card" %>
            <%= link_to @member.account_balance.format, admin_member_adjustments_path(@member) %>
          </li>
        </ul>

        <ul class="member-stats">
          <% if @member.status_verified? %>
            <li><%= feather_icon "user-check" %>Info verified</li>
          <% end %>
          <% if @member.active_membership %>
            <li>
              <%= feather_icon "key" %>
              <%= link_to admin_member_memberships_path(@member) do %>
                Expires <%= @member.active_membership.ended_on.strftime("%b %-d, %Y") %>
              <% end %>
            </li>
          <% end %>
        </ul>

      </div>
      <div class="panel-footer">
        <%= link_to 'Edit Member', edit_admin_member_path(@member), class: "btn" %>
        <%# <%= link_to 'Record Payment', new_admin_member_payment_path(@member), class: "btn" %>
      </div>
    </div>
  </div>

  <div class="column col-sm-12 col-8">

    <% unless @member.notes.blank? %>
      <div class="rich-text">
        <%= @member.notes %>
      </div>
    <% end %>

    <% if !@member.active_membership %>
      <div class="toast member-membership clearfix">
        <p class="float-left"><i class="icon icon-stop"></i> Member needs to start a membership.</p>
        <p class="float-right"><%= link_to "Create Membership", new_admin_member_membership_path(@member) %></p>
      </div>
    <% end %>

    <% unless @member.status_verified? %>
      <div class="toast clearfix member-membership">
        <p class="float-left"><i class="icon icon-stop"></i> Member's ID and zipcode need to be verified.</p>
        <p class="float-right"><%= link_to "Verify Info", edit_admin_member_verification_path(@member) %></p>
      </div>
    <% end %>

    <% if @member.status_verified? %>

      <ul class="tab">
        <li class="tab-item active">
          <a href="#">Current Loans</a>
        </li>
        <li class="tab-item">
          <% if @member.loans.any? %>
            <%= link_to "Previous Loans", admin_member_loan_history_path(@member) %>
          <% else %>
            No Loans
          <% end %>
        </li>
        <li class="tab-item">
          <%= link_to "Membership History", admin_member_memberships_path(@member) %>
        </li>
        <li class="tab-item">
          <%= link_to "Account History", admin_member_adjustments_path(@member) %>
        </li>
      </ul>

      <% if @active_loan_summaries.any? %>

        <div id="current-loans" class="member-active-loans">
          <% @active_loan_summaries.group_by(&:due_at).each do |due_at, summaries| %>
            <div class="columns">
              <div class="column">
                <p class="h5 due-date">Due <strong><%= checked_out_date(due_at) %></strong>
                  (<%= "in " if due_at >= Time.current -%><%= time_ago_in_words(due_at) -%><%= " ago" if due_at < Time.current -%>)
                </p>
              </div>
            </div>
            <% summaries.each do |summary| %>
              <div class="columns mt-2 mb-2">
                <div class="column col-sm-6 col-4">
                  <%= tag.div class: "item-image" do %>
                    <% if summary.item.image.attached? %>
                      <%= link_to admin_item_path(summary.item) do %>
                        <%= image_tag url_for(rotated_variant(summary.item.image, resize_to_limit: [200, 140])), class: "p-right" %>
                      <% end %>
                    <% else %>
                      <div class="image-placeholder"></div>
                    <% end %>
                  <% end %>
                </div>
                <div class="column col-sm-6 col-4">
                  <p><%= full_item_number(summary.item) %></p>
                  <p><%= link_to summary.item.name, admin_item_path(summary.item) %></p>
                  <% if summary.renewed? %>
                    <p>
                      <%= tag.span class:"tooltip tooltip-bottom more-info", data: {tooltip:"Initial check out #{checked_out_date(summary.created_at)}"} do %>Renewed <%= pluralize(summary.renewal_count, "time") %><% end %>
                    </p>
                  <% end %>
                  <% if summary.overdue_as_of?(Time.current) %>
                    <span class="text-error">
                      Current fine: 
                      <%= FineCalculator.for_overdue_loan(summary, Time.current).format %>
                    </span>
                  <% end %>
                </div>
                <div class="column col-sm-12 col-4 text-right">
                  <%= button_to admin_loan_renewals_path(summary.latest_loan), method: :post, class:"btn float-right mb-2" do %>
                    <%= feather_icon "repeat" %>Renew
                  <% end %>
                  <%= button_to [:admin, summary.latest_loan], params: {loan: {ended: 1}}, method: :patch, class:"btn btn-primary float-right mr-2 mb-2" do %>
                    <%= feather_icon "download" %>Return
                  <% end %>
                </div>
              </div>
            <% end %>
            <div class="divider"></div>
          <% end %>
        </div>
      <% end %>

      <% if @member.active_membership %>
        <div class="columns member-checkout-items">
          <div class="column col-12">
            <h2 id="checkout" class="h4">Lend Item</h2>

            <%= portal do %>
              <%= render partial: "admin/check_outs/form" %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>

  </div>
</div>

