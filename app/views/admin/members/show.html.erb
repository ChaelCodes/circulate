<%= render "profile" do %>

  <% unless @member.notes.blank? %>
    <div class="rich-text">
      <%= @member.notes %>
    </div>
  <% end %>

  <% if @active_loan_summaries.any? %>

    <div id="current-loans" class="member-active-loans">
      <% @active_loan_summaries.group_by(&:due_at).each do |due_at, summaries| %>
        <div class="columns">
          <div class="column">
            <p class="h5 due-date">Due <strong><%= checked_out_date(due_at) %></strong>
              (<%= "in " if due_at >= Time.current -%><%= time_ago_in_words(due_at) -%><%= " ago" if due_at < Time.current -%>)
            </p>
          </div>
        </div>
        <% summaries.each do |summary| %>
          <div class="columns mt-2 mb-2">
            <div class="column col-sm-6 col-4">
              <%= tag.div class: "item-image" do %>
                <% if summary.item.image.attached? %>
                  <%= link_to admin_item_path(summary.item) do %>
                    <%= image_tag url_for(rotated_variant(summary.item.image, resize_to_limit: [200, 140])), class: "p-right" %>
                  <% end %>
                <% else %>
                  <div class="image-placeholder"></div>
                <% end %>
              <% end %>
            </div>
            <div class="column col-sm-6 col-4">
              <p><%= full_item_number(summary.item) %></p>
              <p><%= link_to summary.item.name, admin_item_path(summary.item) %></p>
              <% if summary.renewed? %>
                <p>
                  <%= tag.span class:"tooltip tooltip-bottom more-info", data: {tooltip:"Initial check out #{checked_out_date(summary.created_at)}"} do %>Renewed <%= pluralize(summary.renewal_count, "time") %><% end %>
                </p>
              <% end %>
              <% if summary.overdue_as_of?(Time.current) %>
                <span class="text-error">
                  Current fine: 
                  <%= FineCalculator.for_overdue_loan(summary, Time.current).format %>
                </span>
              <% end %>
            </div>
            <div class="column col-sm-12 col-4 text-right">
              <%= button_to [:admin, summary.latest_loan], params: {loan: {ended: 1}}, method: :patch, class:"btn btn-primary mb-2" do %>
                <%= feather_icon "download" %>Return
              <% end %>
              <%= button_to admin_loan_renewals_path(summary.latest_loan), method: :post, class:"btn ml-2 mb-2" do %>
                <%= feather_icon "repeat" %>Renew
              <% end %>
            </div>
          </div>
        <% end %>
        <div class="divider"></div>
      <% end %>
    </div>
  <% end %>

  <% if @member.active_membership && @member.address_verified %>
    <div class="columns member-checkout-items">
      <div class="column col-12">
        <h2 id="checkout" class="h4">Lend Item</h2>

        <%= portal do %>
          <%= render partial: "admin/check_outs/form" %>
        <% end %>
      </div>
    </div>
  <% end %>

<% end %>